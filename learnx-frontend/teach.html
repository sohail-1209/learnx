<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Teach - LearnX</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">
  <style>
    html {
      scroll-behavior: smooth;
    }
    
    /* Card hover effects */
    .card-hover {
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }
    
    .card-hover:hover {
      transform: translateY(-5px);
      border-color: rgba(0, 191, 166, 0.5);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
    }
    
    /* Button animations */
    .btn-primary {
      background-color: #00bfa6;
      transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
      background-color: #009e8d;
      transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0, 191, 166, 0.2);
    }
    
    /* Loading animation */
    @keyframes skeleton-loading {
      0% {
        background-position: -200px 0;
      }
      100% {
        background-position: calc(200px + 100%) 0;
      }
    }
    
    .skeleton-loading {
      background-color: #2d2d2d;
      background-image: linear-gradient(90deg, #2d2d2d, #3d3d3d, #2d2d2d);
      background-size: 200px 100%;
      background-repeat: no-repeat;
      animation: skeleton-loading 1.5s infinite;
      border-radius: 0.375rem;
    }
  </style>
</head>
<body class="gradient-bg text-white font-sans">

  <!-- Flex container for sidebar and content -->
  <div class="flex">
    <!-- Sidebar Placeholder - will be replaced by sidebar-loader.js -->
    <div class="sidebar-placeholder"></div>

    <!-- Main Content -->
    <div class="flex-1 ml-64 p-8">
      <header class="mb-8" data-aos="fade-up">
        <h2 class="text-3xl md:text-4xl font-semibold mb-4">Become a Mentor</h2>
        <p class="text-lg text-secondary">Share your expertise and earn by teaching others on LearnX</p>
      </header>

      <!-- User-specific Teaching Data Sections -->
      <div id="teaching-profile" class="card bg-surface-1 p-6 rounded-xl shadow-lg mb-8 card-hover" data-aos="fade-up">
        <h3 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fas fa-chalkboard-teacher text-primary mr-2"></i>
          Your Teaching Profile
        </h3>
        <!-- Teaching profile loading state -->
        <div class="flex items-center mb-6">
          <div class="skeleton-loading w-24 h-24 rounded-full"></div>
          <div class="ml-4 space-y-2">
            <div class="skeleton-loading h-8 w-48"></div>
            <div class="skeleton-loading h-5 w-36"></div>
            <div class="skeleton-loading h-5 w-24"></div>
          </div>
        </div>
        <div class="mb-4">
          <div class="skeleton-loading h-5 w-32 mb-2"></div>
          <div class="skeleton-loading h-20 w-full"></div>
        </div>
        <div class="skeleton-loading h-10 w-36"></div>
      </div>

      <h2 class="text-3xl md:text-4xl font-semibold mb-6 flex items-center" data-aos="fade-up">
        <i class="fas fa-graduation-cap text-primary mr-3"></i>Your Courses
      </h2>
      <div id="my-courses" class="card bg-surface-1 p-6 rounded-xl shadow-lg mb-8" data-aos="fade-up">
        <!-- Categories -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" data-aos="fade-up">
          <div class="card bg-surface-2 p-6 rounded-xl shadow-lg text-center card-hover">
            <div class="text-primary text-3xl mb-3">
              <i class="fas fa-laptop-code"></i>
            </div>
            <h3 class="text-xl font-semibold">Coding</h3>
            <p class="mt-2 text-lg text-secondary">Teach coding languages like Python, JavaScript, etc.</p>
            <a href="create-listing.html?category=Coding" class="text-primary mt-4 inline-block hover:underline">Start Teaching</a>
          </div>
          <div class="card bg-surface-2 p-6 rounded-xl shadow-lg text-center card-hover">
            <div class="text-primary text-3xl mb-3">
              <i class="fas fa-paint-brush"></i>
            </div>
            <h3 class="text-xl font-semibold">Design</h3>
            <p class="mt-2 text-lg text-secondary">Teach graphic design, UI/UX, etc.</p>
            <a href="create-listing.html?category=Design" class="text-primary mt-4 inline-block hover:underline">Start Teaching</a>
          </div>
          <div class="card bg-surface-2 p-6 rounded-xl shadow-lg text-center card-hover">
            <div class="text-primary text-3xl mb-3">
              <i class="fas fa-music"></i>
            </div>
            <h3 class="text-xl font-semibold">Music</h3>
            <p class="mt-2 text-lg text-secondary">Share your knowledge of music and instruments.</p>
            <a href="create-listing.html?category=Music" class="text-primary mt-4 inline-block hover:underline">Start Teaching</a>
          </div>
          <div class="card bg-surface-2 p-6 rounded-xl shadow-lg text-center card-hover">
            <div class="text-primary text-3xl mb-3">
              <i class="fas fa-dumbbell"></i>
            </div>
            <h3 class="text-xl font-semibold">Fitness</h3>
            <p class="mt-2 text-lg text-secondary">Guide others through fitness routines and wellness tips.</p>
            <a href="create-listing.html?category=Fitness" class="text-primary mt-4 inline-block hover:underline">Start Teaching</a>
          </div>
          <div class="card bg-surface-2 p-6 rounded-xl shadow-lg text-center card-hover">
            <div class="text-primary text-3xl mb-3">
              <i class="fas fa-chart-line"></i>
            </div>
            <h3 class="text-xl font-semibold">Business</h3>
            <p class="mt-2 text-lg text-secondary">Share your business insights and strategies.</p>
            <a href="create-listing.html?category=Business" class="text-primary mt-4 inline-block hover:underline">Start Teaching</a>
          </div>
          <div class="card bg-surface-2 p-6 rounded-xl shadow-lg text-center card-hover">
            <div class="text-primary text-3xl mb-3">
              <i class="fas fa-language"></i>
            </div>
            <h3 class="text-xl font-semibold">Language</h3>
            <p class="mt-2 text-lg text-secondary">Teach new languages to learners.</p>
            <a href="create-listing.html?category=Language" class="text-primary mt-4 inline-block hover:underline">Start Teaching</a>
          </div>
        </div>
        
        <!-- Sessions loading state -->
        <div class="mt-8">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold flex items-center">
              <i class="fas fa-book-open text-primary mr-2"></i>
              Your Sessions
            </h3>
            <a href="create-listing.html" class="btn btn-primary py-2 px-4 rounded-lg flex items-center">
              <i class="fas fa-plus mr-2"></i>
              Add New Session
            </a>
          </div>
          <!-- Loading state -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="skeleton-loading h-48"></div>
            <div class="skeleton-loading h-48"></div>
            <div class="skeleton-loading h-48"></div>
          </div>
        </div>
      </div>

      <h2 class="text-3xl md:text-4xl font-semibold mb-6 flex items-center" data-aos="fade-up">
        <i class="fas fa-star text-primary mr-3"></i>Student Feedback
      </h2>
      <div id="student-feedback" class="card bg-surface-1 p-6 rounded-xl shadow-lg mb-8" data-aos="fade-up">
        <h3 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fas fa-comments text-primary mr-2"></i>Recent Reviews
        </h3>
        <!-- Loading skeleton -->
        <div class="space-y-4">
          <div class="skeleton-loading h-32"></div>
          <div class="skeleton-loading h-32"></div>
        </div>
      </div>

      <h2 class="text-3xl md:text-4xl font-semibold mb-6 flex items-center" data-aos="fade-up">
        <i class="fas fa-wallet text-primary mr-3"></i>Earnings Overview
      </h2>
      <div id="earnings" class="card bg-surface-1 p-6 rounded-xl shadow-lg mb-8" data-aos="fade-up">
        <h3 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fas fa-chart-pie text-primary mr-2"></i>Financial Summary
        </h3>
        <!-- Loading skeleton -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="skeleton-loading h-32"></div>
          <div class="skeleton-loading h-32"></div>
          <div class="skeleton-loading h-32"></div>
        </div>
        <div class="mt-6">
          <h4 class="text-lg font-semibold mb-2 flex items-center">
            <i class="fas fa-history text-primary mr-2"></i>Recent Transactions
          </h4>
          <div class="skeleton-loading h-48"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div id="toast" class="toast-notification">
    <div class="flex items-center">
      <i class="fas fa-info-circle text-primary text-xl mr-3"></i>
      <div>
        <h4 class="font-medium">Information</h4>
        <p class="text-sm text-secondary" id="toast-message">This is a notification.</p>
      </div>
    </div>
  </div>

  <!-- AOS Animation Init -->
  <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
  <script src="js/sidebar-loader.js"></script>
  <script>
    AOS.init({
      duration: 800,
      easing: 'ease-in-out',
      once: true
    });
    
    document.addEventListener("DOMContentLoaded", function() {
      // Get the token from localStorage
      const token = localStorage.getItem('token');
      
      if (!token) {
        showToast("You must be logged in to access the teaching dashboard");
        setTimeout(() => {
          window.location.href = 'login.html'; // Redirect to login page
        }, 2000);
        return;
      }
      
      // Parse the token to get userId
      try {
        const payload = JSON.parse(atob(token.split('.')[1]));
        const userId = payload.userId;
        
        // Fetch user's teaching profile
        fetchTeachingProfile(userId);
        
        // Fetch user's sessions
        fetchTeachingSessions(userId);
        
        // Fetch student feedback/reviews
        fetchStudentFeedback(userId);
        
        // Fetch earnings data
        fetchEarningsData(userId);
      } catch (error) {
        console.error("Error parsing token:", error);
        showToast("Authentication error. Please log in again.");
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 2000);
      }
    });
    
    async function fetchTeachingProfile(userId) {
      try {
        // Clear loading state
        const profileContainer = document.getElementById('teaching-profile');
        
        // Make the actual API call to fetch teaching profile
        const response = await fetch(`http://localhost:5000/api/teach/${userId}`);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to fetch profile');
        }
        
        const data = await response.json();
        
        // Transform the received data into the format expected by displayTeachingProfile
        const teacherProfile = {
          name: data.username || 'Unknown User',
          title: data.profile?.title || 'Teacher at LearnX',
          bio: data.profile?.description || 'No bio available.',
          skills: data.skills || [],
          hourlyRate: data.profile?.hourly_rate || 45,
          rating: data.profile?.rating || 0,
          reviewCount: data.profile?.reviews || 0,
          profilePicture: data.profile_picture_url || 'https://ui-avatars.com/api/?name=User&background=00BFA6&color=fff&size=128&bold=true'
        };
        
        // Display teaching profile
        displayTeachingProfile(teacherProfile);
      } catch (error) {
        console.error("Error fetching teaching profile:", error);
        
        // Handle 404 errors (not a teacher yet)
        if (error.message.includes('not found')) {
          const profileContainer = document.getElementById('teaching-profile');
          profileContainer.innerHTML = `
            <h3 class="text-xl font-semibold mb-4 flex items-center">
              <i class="fas fa-chalkboard-teacher text-primary mr-2"></i>
              Become a Teacher
            </h3>
            <div class="text-center py-6">
              <p class="text-secondary mb-4">You haven't set up your teaching profile yet.</p>
              <button id="become-teacher-btn" class="btn btn-primary py-2 px-6 rounded-lg">
                <i class="fas fa-plus mr-2"></i> Setup Teaching Profile
              </button>
            </div>
          `;
          
          // Add event listener for the become teacher button
          document.getElementById('become-teacher-btn').addEventListener('click', async () => {
            try {
              const token = localStorage.getItem('token');
              
              // Show loading state
              const btn = document.getElementById('become-teacher-btn');
              btn.disabled = true;
              btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
              
              // Send request to become a teacher
              const response = await fetch('http://localhost:5000/api/teach/become', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                }
              });
              
              if (!response.ok) {
                const errorData = await response.json();
                
                // Special handling for when user is already a teacher
                if (response.status === 400 && errorData.error === 'User is already a teacher') {
                  console.log('User is already a teacher, refreshing token to get updated status');
                  
                  // Just refresh the token to get updated isTeacher status
                  const refreshResponse = await fetch('http://localhost:5000/api/auth/refresh-token', {
                    method: 'POST',
                    headers: {
                      'Authorization': `Bearer ${token}`,
                      'Content-Type': 'application/json'
                    }
                  });
                  
                  if (!refreshResponse.ok) {
                    throw new Error('Failed to refresh authentication token');
                  }
                  
                  const refreshData = await refreshResponse.json();
                  // Store the new token with updated teacher status
                  localStorage.setItem('token', refreshData.token);
                  
                  // Set a flag to indicate the user just became a teacher
                  localStorage.setItem('becameTeacher', 'true');
                  
                  showToast("Updating your teacher profile...");
                  
                  setTimeout(() => {
                    window.location.reload();
                  }, 1500);
                  return;
                }
                
                throw new Error(errorData.error || 'Failed to become a teacher');
              }
              
              // Get a fresh token with updated teacher status
              const refreshResponse = await fetch('http://localhost:5000/api/auth/refresh-token', {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json'
                }
              });
              
              if (!refreshResponse.ok) {
                throw new Error('Failed to refresh authentication token');
              }
              
              const refreshData = await refreshResponse.json();
              // Store the new token with updated teacher status
              localStorage.setItem('token', refreshData.token);
              
              showToast("You're now a teacher! Setting up your profile...");
              
              // Set a flag to indicate the user just became a teacher
              localStorage.setItem('becameTeacher', 'true');
              
              setTimeout(() => {
                window.location.reload();
              }, 2000);
            } catch (error) {
              console.error("Error becoming a teacher:", error);
              showToast("Error: " + error.message);
              
              // Reset button state
              const btn = document.getElementById('become-teacher-btn');
              btn.disabled = false;
              btn.innerHTML = '<i class="fas fa-plus mr-2"></i> Setup Teaching Profile';
            }
          });
        } else {
          showToast("Error loading teaching profile. Please try again.");
        }
      }
    }
    
    function displayTeachingProfile(data) {
      const profileContainer = document.getElementById('teaching-profile');
      
      profileContainer.innerHTML = `
        <h3 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fas fa-chalkboard-teacher text-primary mr-2"></i>
          Your Teaching Profile
        </h3>
        <div class="flex flex-col md:flex-row items-start md:items-center mb-6">
          <img src="${data.profilePicture}" alt="${data.name}" class="w-24 h-24 rounded-full object-cover border-2 border-primary">
          <div class="mt-4 md:mt-0 md:ml-4">
            <h4 class="text-xl font-semibold">${data.name}</h4>
            <p class="text-primary">${data.title}</p>
            <div class="flex items-center mt-1">
              <div class="text-warning flex mr-2">
                ${'★'.repeat(Math.round(data.rating))}
              </div>
              <span class="text-secondary text-sm">(${data.reviewCount} reviews)</span>
            </div>
          </div>
          <div class="md:ml-auto mt-4 md:mt-0">
            <p class="text-xl font-semibold text-primary">$${data.hourlyRate}/hour</p>
          </div>
        </div>
        <div class="mb-6">
          <h4 class="font-semibold mb-2">About</h4>
          <p class="text-secondary">${data.bio}</p>
        </div>
        <div class="mb-6">
          <h4 class="font-semibold mb-2">Skills</h4>
          <div class="flex flex-wrap gap-2">
            ${data.skills.map(skill => `<span class="badge-primary py-1 px-3 rounded-full text-sm">${skill}</span>`).join('')}
          </div>
        </div>
        <div class="flex justify-end">
          <a href="profile.html" class="btn btn-primary py-2 px-4 rounded-lg">
            <i class="fas fa-edit mr-2"></i> Edit Profile
          </a>
        </div>
      `;
    }
    
    async function fetchTeachingSessions(userId) {
      try {
        console.log(`Fetching teaching sessions for user ID: ${userId}`);
        
        // Make the actual API call to fetch user's teaching sessions
        const response = await fetch(`http://localhost:5000/api/teach/${userId}`);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to fetch sessions');
        }
        
        const data = await response.json();
        
        console.log("Raw session data received:", data);
        
        // Ensure sessions exists and is an array
        if (!data.sessions || !Array.isArray(data.sessions)) {
          console.warn("No sessions array found in API response");
          displayTeachingSessions([]);
          return;
        }
        
        console.log("Session IDs in response:", data.sessions.map(s => s.id));
        
        // Transform the received data into the format expected by displayTeachingSessions
        const sessions = data.sessions.map(session => ({
          id: session.id,
          title: session.title || 'Untitled Session',
          description: session.description || 'No description available',
          category: session.category || 'Other',
          price: parseFloat(session.price) || 0,
          duration: session.duration || 60,
          schedule: session.datetime || new Date().toISOString(),
          enrolledStudents: session.current_students || 0,
          maxStudents: session.max_students || 10
        }));
        
        console.log("Sessions data received (count):", data.sessions.length);
        console.log("Processed sessions for display (count):", sessions.length);
        
        // Check if there was a last created session to highlight
        const lastCreatedSessionId = localStorage.getItem('lastCreatedSessionId');
        if (lastCreatedSessionId) {
          console.log("Looking for last created session ID:", lastCreatedSessionId);
          const foundSession = sessions.find(s => s.id == lastCreatedSessionId);
          console.log("Last created session found:", foundSession ? "Yes" : "No");
        }
        
        // Display sessions
        displayTeachingSessions(sessions);
      } catch (error) {
        console.error("Error fetching teaching sessions:", error);
        
        // If the user isn't a teacher yet, just show empty sessions
        if (error.message.includes('not found')) {
          displayTeachingSessions([]);
        } else {
          showToast("Error loading teaching sessions. Please try again.");
          // Add a debug refresh button
          const refreshBtn = document.createElement('button');
          refreshBtn.className = 'btn btn-primary mx-auto mt-4 block';
          refreshBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> Refresh Sessions';
          refreshBtn.onclick = () => {
            try {
              const payload = JSON.parse(atob(localStorage.getItem('token').split('.')[1]));
              fetchTeachingSessions(payload.userId);
            } catch (e) {
              console.error("Error refreshing sessions:", e);
            }
          };
          
          const sessionsContent = document.querySelector('#my-courses .grid:nth-child(2)');
          sessionsContent.appendChild(refreshBtn);
        }
      }
    }
    
    function displayTeachingSessions(sessions) {
      const sessionsContainer = document.getElementById('my-courses');
      const sessionsContent = sessionsContainer.querySelector('.grid:nth-child(2)');
      
      // Check if there was a newly created session to highlight
      const lastCreatedSessionId = localStorage.getItem('lastCreatedSessionId');
      
      if (sessions.length === 0) {
        sessionsContent.innerHTML = `
          <div class="col-span-3 text-center py-8">
            <p class="text-secondary mb-4">You haven't created any teaching sessions yet.</p>
            <div class="flex justify-center">
              <a href="create-listing.html" class="btn btn-primary py-2 px-6 rounded-lg">
                <i class="fas fa-plus mr-2"></i> Create Your First Session
              </a>
            </div>
            <p class="text-xs text-secondary mt-4">If you just created a session and don't see it, try refreshing the page.</p>
            <button id="manual-refresh-btn" class="btn btn-secondary mt-4">
              <i class="fas fa-sync-alt mr-2"></i> Manual Refresh
            </button>
          </div>
        `;
        
        // Add event listener to the manual refresh button
        setTimeout(() => {
          const refreshBtn = document.getElementById('manual-refresh-btn');
          if (refreshBtn) {
            refreshBtn.addEventListener('click', () => {
              try {
                const payload = JSON.parse(atob(localStorage.getItem('token').split('.')[1]));
                fetchTeachingSessions(payload.userId);
                showToast("Refreshing sessions data...");
              } catch (e) {
                console.error("Error refreshing sessions:", e);
              }
            });
          }
        }, 100);
        
        return;
      }
      
      sessionsContent.innerHTML = '';
      
      // Add refresh button at the top
      const refreshContainer = document.createElement('div');
      refreshContainer.className = 'col-span-3 mb-4 flex justify-end';
      refreshContainer.innerHTML = `
        <button id="refresh-sessions-btn" class="btn btn-secondary py-2 px-4 rounded-lg text-sm">
          <i class="fas fa-sync-alt mr-2"></i> Refresh Sessions
        </button>
      `;
      sessionsContent.appendChild(refreshContainer);
      
      // Add event listener to the refresh button
      setTimeout(() => {
        const refreshBtn = document.getElementById('refresh-sessions-btn');
        if (refreshBtn) {
          refreshBtn.addEventListener('click', () => {
            try {
              const payload = JSON.parse(atob(localStorage.getItem('token').split('.')[1]));
              fetchTeachingSessions(payload.userId);
              showToast("Refreshing sessions data...");
            } catch (e) {
              console.error("Error refreshing sessions:", e);
            }
          });
        }
      }, 100);
      
      sessions.forEach(session => {
        const sessionCard = document.createElement('div');
        sessionCard.className = 'card bg-surface-2 p-4 rounded-xl shadow-lg card-hover';
        
        // Highlight newly created session
        if (lastCreatedSessionId && session.id.toString() === lastCreatedSessionId.toString()) {
          sessionCard.classList.add('border-2', 'border-primary');
          // Clear the stored ID after we've highlighted it
          setTimeout(() => localStorage.removeItem('lastCreatedSessionId'), 5000);
        }
        
        const date = new Date(session.schedule);
        const formattedDate = date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric', 
          year: 'numeric' 
        });
        
        const formattedTime = date.toLocaleTimeString('en-US', { 
          hour: '2-digit', 
          minute: '2-digit'
        });
        
        sessionCard.innerHTML = `
          <h4 class="text-lg font-semibold">${session.title}</h4>
          <p class="text-secondary text-sm mt-1 mb-3">${session.description}</p>
          <div class="flex justify-between mb-2 text-sm">
            <span class="text-primary"><i class="fas fa-tag mr-1"></i> ${session.category}</span>
            <span class="text-primary">$${session.price} / ${session.duration} min</span>
          </div>
          <div class="flex justify-between mb-4 text-sm text-secondary">
            <span><i class="fas fa-calendar mr-1"></i> ${formattedDate}</span>
            <span><i class="fas fa-clock mr-1"></i> ${formattedTime}</span>
          </div>
          <div class="flex justify-between items-center text-sm">
            <span><i class="fas fa-users mr-1"></i> ${session.enrolledStudents}/${session.maxStudents} students</span>
            <div class="flex space-x-2">
              <button class="text-primary hover:text-primary-dark" data-session-id="${session.id}">
                <i class="fas fa-edit"></i>
              </button>
              <button class="text-error hover:text-opacity-80" data-session-id="${session.id}">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </div>
          ${lastCreatedSessionId && session.id.toString() === lastCreatedSessionId.toString() ? 
            '<div class="mt-2 text-xs text-primary">✓ Newly created session</div>' : ''}
        `;
        
        sessionsContent.appendChild(sessionCard);
      });
      
      // Add a small debug section
      if (sessions.length > 0) {
        const debugInfo = document.createElement('div');
        debugInfo.className = 'col-span-3 text-center mt-4';
        debugInfo.innerHTML = `
          <p class="text-xs text-secondary mt-4">Displaying ${sessions.length} session(s).</p>
        `;
        sessionsContent.appendChild(debugInfo);
      }
    }
    
    async function fetchStudentFeedback(userId) {
      try {
        // Make the actual API call to fetch student feedback
        const response = await fetch(`http://localhost:5000/api/teach/${userId}/reviews`);
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to fetch reviews');
        }
        
        const data = await response.json();
        
        // Transform the received data into the format expected by displayStudentFeedback
        const reviews = (data.reviews || []).map(review => ({
          id: review.id,
          studentName: review.student_name || 'Anonymous Student',
          sessionTitle: review.session_title || 'Session',
          rating: review.rating || 5,
          comment: review.comment || 'No comment provided',
          date: review.created_at || new Date().toISOString()
        }));
        
        // Display feedback
        displayStudentFeedback(reviews);
      } catch (error) {
        console.error("Error fetching student feedback:", error);
        
        // If the user isn't a teacher yet, just show empty reviews
        if (error.message.includes('not found')) {
          displayStudentFeedback([]);
        } else {
          showToast("Error loading student feedback. Please try again.");
        }
      }
    }
    
    function displayStudentFeedback(reviews) {
      const feedbackContainer = document.getElementById('student-feedback');
      
      if (reviews.length === 0) {
        feedbackContainer.innerHTML = `
          <h3 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fas fa-comments text-primary mr-2"></i>Recent Reviews
          </h3>
          <div class="text-center py-6">
            <p class="text-secondary">You haven't received any reviews yet.</p>
          </div>
        `;
        return;
      }
      
      let reviewsHTML = `
        <h3 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fas fa-comments text-primary mr-2"></i>Recent Reviews
        </h3>
        <div class="space-y-4">
      `;
      
      reviews.forEach(review => {
        const date = new Date(review.date);
        const formattedDate = date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric', 
          year: 'numeric' 
        });
        
        reviewsHTML += `
          <div class="testimonial-card">
            <div class="flex justify-between items-start mb-2">
              <div>
                <div class="text-warning">${'★'.repeat(review.rating)}</div>
                <p class="font-semibold mt-1">${review.studentName}</p>
              </div>
              <span class="text-secondary text-sm">${formattedDate}</span>
            </div>
            <p class="text-secondary">${review.comment}</p>
            <p class="text-xs text-primary mt-2">Session: ${review.sessionTitle}</p>
          </div>
        `;
      });
      
      reviewsHTML += `</div>`;
      feedbackContainer.innerHTML = reviewsHTML;
    }
    
    async function fetchEarningsData(userId) {
      try {
        // For now, use placeholder data since this endpoint might not exist yet
        // In the future, can replace with real API call:
        // const response = await fetch(`http://localhost:5000/api/teach/${userId}/earnings`);
        // const data = await response.json();
        
        // Use placeholder data for now
        const data = {
          totalEarnings: 0,
          pendingPayouts: 0,
          monthlyEarnings: 0,
          transactions: []
        };
        
        // Display earnings data
        displayEarningsData(data);
      } catch (error) {
        console.error("Error fetching earnings data:", error);
        
        // Create default earning data for display
        const defaultData = {
          totalEarnings: 0,
          pendingPayouts: 0,
          monthlyEarnings: 0,
          transactions: []
        };
        
        // Display default earnings data
        displayEarningsData(defaultData);
      }
    }
    
    function displayEarningsData(data) {
      const earningsContainer = document.getElementById('earnings');
      
      let earningsHTML = `
        <h3 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fas fa-chart-pie text-primary mr-2"></i>Financial Summary
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
          <div class="card bg-surface-2 p-4 rounded-xl shadow-lg">
            <p class="text-secondary mb-1">Total Earnings</p>
            <p class="text-2xl font-bold">$${data.totalEarnings.toFixed(2)}</p>
          </div>
          <div class="card bg-surface-2 p-4 rounded-xl shadow-lg">
            <p class="text-secondary mb-1">Pending Payouts</p>
            <p class="text-2xl font-bold">$${data.pendingPayouts.toFixed(2)}</p>
          </div>
          <div class="card bg-surface-2 p-4 rounded-xl shadow-lg">
            <p class="text-secondary mb-1">This Month</p>
            <p class="text-2xl font-bold">$${data.monthlyEarnings.toFixed(2)}</p>
          </div>
        </div>
      `;
      
      // Recent transactions
      earningsHTML += `
        <div>
          <h4 class="text-lg font-semibold mb-4 flex items-center">
            <i class="fas fa-history text-primary mr-2"></i>Recent Transactions
          </h4>
          <div class="bg-surface-2 rounded-xl overflow-hidden">
            <table class="w-full text-left">
              <thead class="bg-surface-3">
                <tr>
                  <th class="py-3 px-4">Date</th>
                  <th class="py-3 px-4">Description</th>
                  <th class="py-3 px-4">Amount</th>
                  <th class="py-3 px-4">Status</th>
                </tr>
              </thead>
              <tbody>
      `;
      
      data.transactions.forEach(transaction => {
        const date = new Date(transaction.date);
        const formattedDate = date.toLocaleDateString('en-US', { 
          month: 'short', 
          day: 'numeric', 
          year: 'numeric' 
        });
        
        const amountClass = transaction.amount >= 0 ? 'text-success' : 'text-error';
        const amountPrefix = transaction.amount >= 0 ? '+' : '';
        
        earningsHTML += `
          <tr class="border-b border-surface-3">
            <td class="py-3 px-4">${formattedDate}</td>
            <td class="py-3 px-4">${transaction.description}</td>
            <td class="py-3 px-4 font-semibold ${amountClass}">${amountPrefix}$${Math.abs(transaction.amount).toFixed(2)}</td>
            <td class="py-3 px-4">${transaction.status}</td>
          </tr>
        `;
      });
      
      earningsHTML += `
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      earningsContainer.innerHTML = earningsHTML;
    }
    
    // Toast notification function
    function showToast(message) {
      const toast = document.getElementById('toast');
      document.getElementById('toast-message').textContent = message;
      toast.classList.add('show');
      
      setTimeout(() => {
        toast.classList.remove('show');
      }, 3000);
    }
  </script>
</body>
</html>
